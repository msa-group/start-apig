
Composer:
  Backend:
    Existed: {{IsNotEmpty(Get(Parameters, "Service.ServiceId"))}}
    Component: cs.application
    Parameters:
      AppName: {{Get(Parameters, "Backend.Name")}}
      ClusterId: {{Get(Parameters, "Backend.ClusterId")}}
      Namespace: {{Get(Parameters, "Backend.Namespace")}}
      YamlContent: {{Indent(Get(Parameters, "Service.YamlContent"), 5)}}

  Service:
    DependsOn: Backend
    Component: apig.service
    Parameters:
      Name: {{Default(Get(Parameters, 'Service.Name'), Subfix(Parameters.Name))}}
      SourceType: FC3
     
  LLMSvc:
    Component: apig.service
    Parameters:
      Name: {{Default(Get(Parameters, 'LLMSvc.Name'), Subfix('dashscope-svc'))}}
      DnsConfig:
        AddressesName: dashscope.aliyuncs.com
        Port: 443
  
  HttpApi:
    Component: apig.http
    Parameters:
      Name: {{Default(Get(Parameters, 'HttpApi.Name'), Subfix(Join([Parameters.Name, 'http'])))}}
      Routes:
        - Name: {{Default(Get(Parameters, 'HttpApi.RouteNames[0]'), 'index')}}
          Path: 
            Type: Prefix
            Value: '/'
          Scene: SingleService
          Services:
            - ServiceId: {{RosOutput(Service, "ServiceId")}}
              Protocol: HTTP
              Weight: 100
        - Name: {{Default(Get(Parameters, 'HttpApi.RouteNames[1]'), 'dashscope')}}
          Path: 
            Type: Prefix
            Value: '/v1'
          Methods:
            - POST
          Scene: SingleService
          Services:
            - ServiceId: {{RosOutput(LLMSvc, "ServiceId")}}
              Protocol: HTTP
              Weight: 100
          Plugins:
            - PluginClassId: pls-cqebrgh4ckt6ppatmprh
              PluginConfig: |
                provider:
                  modelMapping:
                    '*': qwen-max
                  type: qwen
                  apiTokens:
                    - sk-xxx
       
